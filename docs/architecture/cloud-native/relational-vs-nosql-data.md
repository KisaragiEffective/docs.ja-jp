---
title: リレーショナルデータとNoSQLデータ
description: クラウドネイティブアプリケーションのリレーショナルデータとNoSQLデータについて学ぶ
author: robvet
ms.date: 01/22/2020
ms.openlocfilehash: 04693e30ba3848f1e51f1c69a75be5f18ead4cf1
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/12/2020
ms.locfileid: "79141420"
---
# <a name="relational-vs-nosql-data"></a>リレーショナルデータとNoSQLデータ

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

リレーショナルと NoSQL は、一般的にクラウドネイティブアプリケーションに実装される 2 種類のデータベースシステムです。 異なる方法で構築され、データの保存方法が異なり、アクセス方法が異なります。 このセクションでは、両方を見てみましょう。 この章の後半では *、NewSQL*という新しいデータベーステクノロジについて説明します。

*リレーショナル データベース*は、何十年もの間普及しているテクノロジです。 成熟し、実績があり、広く実装されています。 競合するデータベース製品、ツーリング、専門知識が豊富に含まれています。 リレーショナル データベースは、関連するデータ テーブルのストアを提供します。 これらのテーブルには固定スキーマがあり、SQL (構造化照会言語) を使用してデータを管理し、ACID 保証をサポートします。

*SQL データベースは*、高パフォーマンスで非リレーショナル データ ストアを参照します。 使いやすさ、スケーラビリティ、復元性、可用性の特性に優れています。 正規化されたデータのテーブルを結合する代わりに、NoSQL は構造化されていないデータまたは半構造化されたデータを、多くの場合、キーと値のペアまたは JSON ドキュメントに格納します。 通常、SQL データベースは、単一のデータベース・パーティションの範囲を超える ACID 保証を提供しません。 サブ秒応答時間を必要とする大量のサービスは、NoSQL データストアを優先します。

分散クラウドネイティブシステムに対する[NoSQL](https://www.geeksforgeeks.org/introduction-to-nosql/)テクノロジーの影響は、誇張することはできません。 この分野で新しいデータテクノロジが普及し、かつてはリレーショナルデータベースのみに依存していたソリューションが混乱しています。

NoSQL データベースには、データにアクセスして管理するための複数の異なるモデルが含まれ、それぞれが特定のユースケースに適しています。 図 5-9 に、一般的なモデルを 4 つ示します。

![NoSQL データモデル](./media/types-of-nosql-datastores.png)

**図 5-9**: NoSQL データベースのデータ モデル

| モデル | 特性 |
| :-------- | :-------- |
| ドキュメント ストア | データとメタデータは、データベース内の JSON ベースのドキュメントに階層的に格納されます。 |
| キー値ストア | 最も単純な NoSQL データベースでは、データはキーと値のペアのコレクションとして表されます。 |
| ワイドカラムストア | 関連データは、1 つの列内に入れ子になったキーと値のペアのセットとして格納されます。 |
| グラフストア | データは、ノード、エッジ、およびデータのプロパティとしてグラフ構造に格納されます。 |

## <a name="the-cap-theorem"></a>CAP定理

これらのタイプのデータベースの違いを理解する方法として、状態を格納する分散システムに適用される一連の原則である CAP 定理を検討してください。 図 5-10 は、CAP 定理の 3 つのプロパティを示しています。

![CAP 定理](./media/cap-theorem.png)

**図 5-10** CAP定理

この定理では、分散データ システムは、整合性、可用性、およびパーティション許容範囲の間のトレードオフを提供すると述べています。 また、どのデータベースでも、次の 3 つのプロパティのうち*2 つの*プロパティしか保証できません。

- *一貫性。* すべてのレプリカが更新されるまでシステムが要求をブロックする必要がある場合でも、クラスター内のすべてのノードが最新のデータで応答します。 現在更新中のアイテムに対して"整合性のあるシステム" を照会する場合は、すべてのレプリカが正常に更新されるまで、その応答を待ちます。 ただし、最新のデータを受け取ります。

- *可用性。* すべてのノードは、その応答が最新のデータではない場合でも、即時応答を返します。 更新中のアイテムに対して "使用可能なシステム" を照会すると、その時点でサービスが提供できる最適な回答が得られます。

- *パーティション許容度。* レプリケートされたデータ ノードに障害が発生した場合や、他のレプリケートされたデータ ノードとの接続が失われた場合でも、システムの動作を継続します。

リレーショナル データベースは、通常、整合性と可用性を提供しますが、パーティションの許容範囲は提供しません。 通常、単一のサーバーにプロビジョニングされ、マシンにリソースを追加して垂直方向にスケーリングします。

多くのリレーショナル データベース システムでは、プライマリ データベースのコピーを他のセカンダリ サーバー インスタンスにコピーできる組み込みのレプリケーション機能がサポートされています。 書き込み操作はプライマリ インスタンスに対して行われ、各セカンダリにレプリケートされます。 障害が発生した場合、プライマリ インスタンスはセカンダリにフェールオーバーして高可用性を実現できます。 セカンダリは、読み取り操作を分散するためにも使用できます。 書き込み操作は常にプライマリ レプリカに対して行われますが、読み取り操作は任意のセカンダリにルーティングされ、システム負荷を軽減できます。

シャーディング など、複数のノード間でデータ[を水平方向に](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-scale-introduction)分割することもできます。 しかし、シャーディングは、容易に通信できない多くの部分にデータを吐き出すことで、運用上のオーバーヘッドを大幅に増加させます。 管理にはコストがかかり、時間がかかる場合があります。 最終的には、パフォーマンス、テーブル結合、参照整合性に影響を与える可能性があります。

データ レプリカが"非常に一貫性のある" リレーショナル データベース クラスタでネットワーク接続を失うと、データベースに書き込む機能はありません。 システムは、その変更を他のデータ レプリカにレプリケートできないので、書き込み操作を拒否します。 トランザクションを完了する前に、すべてのデータ レプリカを更新する必要があります。

NoSQL データベースは、通常、高可用性とパーティション許容度をサポートします。 多くの場合、コモディティ サーバー間で水平方向にスケール アウトします。 このアプローチは、地理的地域内および地域全体で、コストを削減して、驚異的な可用性を提供します。 これらのマシンまたはノード間でデータをパーティション化してレプリケートし、冗長性とフォールト トレランスを実現します。 欠点は一貫性です。 1 つの NoSQL ノード上のデータの変更は、他のノードに伝播するのに時間がかかる場合があります。 通常、NoSQL データベースノードは、提示されたデータが古く、まだ更新されていない場合でも、クエリに対して即時応答を提供します。

「高可用性」NoSQL データベースクラスターでデータレプリカの接続が失われた場合でも、データベースへの書き込み操作を完了できます。 データベース クラスタは書き込み操作を許可し、各データ レプリカが使用可能になったときに更新します。

この種の結果は、ACID トランザクションがサポートされていない分散データ システムの特性である、最終的な整合性と呼ばれます。 データ項目の更新と、その更新を各レプリカ ノードに反映するのにかかる時間の間の短い遅延です。 通常の条件では、通常はラグは短いですが、問題が発生すると増加する可能性があります。 たとえば、米国の NoSQL データベースの製品項目を更新し、ヨーロッパのレプリカ ノードから同じデータ項目をクエリするとどうなるでしょうか。 クラスターが製品の変更に伴ってヨーロッパのノードを更新するまで、以前の製品情報を受け取ります。 クエリ結果をすぐに返し、すべてのレプリカ ノードの更新を待たないと、膨大な規模とボリュームが得られますが、古いデータを表示する可能性があります。

高い可用性と大規模なスケーラビリティは、多くの場合、強力な一貫性よりもビジネスにとって重要です。 開発者は、佐賀、CQRS、非同期メッセージングなどの手法やパターンを実装して、最終的な一貫性を取り入れることができます。

> 今日では、CAP 定理制約を連結する際には注意が必要です。 新しい種類の NewSQL が登場し、リレーショナル データベース エンジンを拡張して、水平スケーラビリティと NoSQL システムのスケーラブルなパフォーマンスの両方をサポートしています。

## <a name="considerations-for-relational-vs-nosql-systems"></a>リレーショナルシステムとNoSQLシステムに関する考慮事項

特定のデータ要件に基づいて、クラウド ネイティブ ベースのマイクロサービスは、リレーショナル、NoSQL データストア、またはその両方を実装できます。

|  次の場合に NoSQL データストアを検討してください。 | 次の場合にリレーショナル データベースを検討してください。 |
| :-------- | :-------- |
| 大規模なワークロードを必要とする大量のワークロードがある場合 | ワークロードの量は一貫性があり、中規模から大規模なスケールが必要 |
| ワークロードに ACID 保証が必要ない |  ACID保証が必要です |
| データは動的で、頻繁に変更される | データは予測可能で高度に構造化されています |
| データは関係なしで表現できる | データはリレーショナルで最もよく表現される |  
| 高速書き込みが必要で、書き込みの安全性は重要ではありません | 書き込み安全性は必須条件 |  
| データの取得は単純で、フラットになる傾向があります | 複雑なクエリとレポートを使用する|
| データには幅広い地理的分布が必要 | ユーザーの集中管理 |
| アプリケーションは、パブリック クラウドなどのコモディティ ハードウェアに展開されます。 | アプリケーションは、大規模でハイエンドのハードウェアに展開されます。 |
|||

以降のセクションでは、クラウド ネイティブ データの格納と管理に使用できる Azure クラウドで使用できるオプションについて説明します。

## <a name="database-as-a-service"></a>サービスとしてのデータベース

まず、Azure 仮想マシンをプロビジョニングし、各サービスに適したデータベースをインストールします。 環境を完全に制御できる一方で、クラウド プラットフォームの多くの組み込み機能を見落とします。 また、各サービスの仮想マシンとデータベースの管理も担当します。 このアプローチは、時間とコストが急速に高くなる可能性があります。

代わりに、クラウド ネイティブ アプリケーションは、[サービスとしてのデータベース (DBaaS) として](https://www.stratoscale.com/blog/dbaas/what-is-database-as-a-service/)公開されるデータ サービスを優先します。 クラウド ベンダーによって完全に管理されているこれらのサービスは、組み込みのセキュリティ、スケーラビリティ、および監視を提供します。 サービスを所有する代わりに、単に[バッキング サービス](./definition.md#backing-services)として使用します。 プロバイダは、大規模なリソースを運用し、パフォーマンスとメンテナンスの責任を負います。

これらのサービスは、クラウドの可用性ゾーンとリージョン間で構成して、高可用性を実現できます。 彼らはすべてジャストインタイム容量と従量課金制モデルをサポートしています。 Azure には、さまざまな種類のマネージド データ サービス オプションが用意され、それぞれに特定の利点があります。

まず、Azure で利用できるリレーショナル DBaaS サービスについて説明します。 マイクロソフトの主力 SQL Server データベースと、いくつかのオープン ソース オプションが用意されています。 次に、Azure の NoSQL データ サービスについて説明します。

## <a name="azure-relational-databases"></a>Azure リレーショナル データベース

リレーショナル データを必要とするクラウド ネイティブ マイクロサービスの場合、Azure は、4 つのマネージド リレーショナル データベースをサービス (DBaaS) として提供しています (図 5-11 参照)。

![Azure のマネージ リレーショナル データベース](./media/azure-managed-databases.png)

**図 5-11** Azure で使用できるマネージド リレーショナル データベース

前の図では、各インフラストラクチャが、追加コストなしで主要な機能を備えた共通の DBaaS インフラストラクチャにどのように存在するかを確認します。

これらの機能は、多数のデータベースをプロビジョニングする組織にとって特に重要ですが、管理するリソースが限られています。
処理コア、メモリ、および基になるストレージの量を選択することで、Azure データベースを数分でプロビジョニングできます。 データベースをリアルタイムでスケールし、ダウンタイムをほとんどまたはまったくからなく、リソースを動的に調整できます。

## <a name="azure-sql-database"></a>Azure SQL データベース

マイクロソフト SQL Server の専門知識を持つ開発チームは[、Azure SQL データベース](https://docs.microsoft.com/azure/sql-database/)を検討する必要があります。 これは、Microsoft SQL Server データベース エンジンに基づく完全に管理されたリレーショナル データベースサービスとしての (DBaaS) です。 このサービスは、オンプレミスバージョンの SQL Server で見つかった多くの機能を共有し、最新の安定バージョンの SQL Server データベース エンジンを実行します。

クラウドネイティブマイクロサービスで使用するために、Azure SQL データベースには 3 つのデプロイオプションがあります。

- 単一データベースは[、Azure](https://docs.microsoft.com/azure/sql-database/sql-database-servers)クラウド内の Azure SQL データベース サーバーで実行されている完全に管理された SQL データベースを表します。 データベースは、基になるデータベース サーバーに対する構成の依存関係がないため、[*包含*](https://docs.microsoft.com/sql/relational-databases/databases/contained-databases)と見なされます。
  
- [マネージド インスタンス](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance)は、オンプレミスの SQL Server との互換性を 100% 近く提供する、Microsoft SQL Server データベース エンジンの完全マネージド インスタンスです。 このオプションは、最大 35 TB の大規模なデータベースをサポートし、分離を向上させるために[Azure 仮想ネットワーク](https://docs.microsoft.com/azure/virtual-network/virtual-networks-overview)に配置されます。

- [Azure SQL Database サーバーレス](https://docs.microsoft.com/azure/sql-database/sql-database-serverless)は、ワークロードの需要に基づいて自動的にスケーリングされる単一のデータベースのコンピューティング層です。 1 秒あたりに使用されるコンピューティングの量に対してのみ請求されます。 このサービスは、断続的で予測不可能な使用パターンを持つワークロードに適しており、非アクティブな期間が散在します。 また、サーバーレスコンピューティング層は、非アクティブ期間中にデータベースを自動的に一時停止し、ストレージ料金のみが課金されるようにします。 アクティビティが戻ると自動的に再開されます。

従来の Microsoft SQL Server スタックを超えて、Azure には、一般的な 3 つのオープン ソース データベースのマネージ バージョンも用意されています。

## <a name="open-source-databases-in-azure"></a>Azure のオープン ソース データベース

オープンソースのリレーショナルデータベースは、クラウドネイティブアプリケーションに人気の選択肢となっています。 多くの企業は、特にコスト削減のために、商用データベース製品よりも彼らを支持します。 多くの開発チームは、柔軟性、コミュニティに支援された開発、ツールと拡張機能のエコシステムを享受しています。 オープンソースデータベースは、複数のクラウドプロバイダーに展開できるため、「ベンダーのロックイン」の懸念を最小限に抑えることができます。

開発者は、Azure VM 上の任意のオープン ソース データベースを簡単に自己ホストできます。 このアプローチでは、完全な制御を提供しながら、データベースと VM の管理、監視、および保守を行います。

しかし、マイクロソフトは、*完全に管理*された DBaaS サービスとしていくつかの一般的なオープンソース データベースを提供することで、Azure を「オープン プラットフォーム」に保つというコミットメントを継続しています。

### <a name="azure-database-for-mysql"></a>Azure Database for MySQL

[MySQL](https://en.wikipedia.org/wiki/MySQL) はオープンソースのリレーショナルデータベースであり[、LAMP ソフトウェアスタック](https://en.wikipedia.org/wiki/LAMP_(software_bundle))上に構築されたアプリケーションの柱です。 *読み取り負荷の高い*ワークロードに広く選ばれ、Facebook、Twitter、YouTubeなど多くの大規模な組織で使用されています。 コミュニティ版は無料で利用できますが、エンタープライズ版ではライセンスの購入が必要です。 1995年に創作されたこの製品は、2008年にサン・マイクロシステムズによって購入されました。 オラクルは2010年にサンとMySQLを買収した。

[MySQL 用 Azure データベース](https://azure.microsoft.com/services/mysql/)は、オープン ソースの MySQL Server エンジンに基づく管理されたリレーショナル データベース サービスです。 これは、MySQL コミュニティエディションを使用します。 Azure MySQL サーバーは、サービスの管理ポイントです。 オンプレミスの展開に使用されるのと同じ MySQL サーバー エンジンです。 エンジンは、1 つのサーバーにつき 1 つのデータベースを作成することも、リソースを共有するサーバーごとに複数のデータベースを作成することもできます。 新しいスキルを習得したり、仮想マシンを管理したりすることなく、同じオープンソースツールを使用してデータを管理し続けることができます。

### <a name="azure-database-for-mariadb"></a>Azure Database for MariaDB

[マリアド](https://mariadb.com/)サーバーは、もう 1 つの一般的なオープンソース データベース サーバーです。 これは、オラクルがMySQLを所有していたサンマイクロシステムズを購入したときにMySQLの*フォーク*として作成されました。 その目的は、MariaDB がオープンソースのままであることを保証することであった。 MariaDB は MySQL のフォークであるため、データとテーブルの定義は互換性があり、クライアントプロトコル、構造体、API は密接に結び付いています。

MariaDBは強力なコミュニティを持ち、多くの大企業で使用されています。 Oracle は MySQL の保守、強化、サポートを継続していますが、MariaDB の基盤は MariaDB を管理し、製品とドキュメントへの一般の貢献を可能にします。

[MariaDB 用の Azure データベース](https://azure.microsoft.com/services/mariadb/)は、Azure クラウドのサービスとして完全に管理されたリレーショナル データベースです。 このサービスは、MariaDB コミュニティエディションのサーバーエンジンに基づいています。 予測可能なパフォーマンスと動的なスケーラビリティで、ミッションクリティカルなワークロードを処理できます。

### <a name="azure-database-for-postgresql"></a>Azure Database for PostgreSQL

[PostgreSQL](https://www.postgresql.org/)は、30年以上の開発を行うオープンソースのリレーショナルデータベースです。 PostgresSQL は信頼性とデータ整合性に対して高い評価を得ています。 特に複雑なクエリや大量の書き込みを伴うワークロードでは、機能が豊富で、SQLに準拠しており、MySQLよりもパフォーマンスが高いと考えられています。 アップル、レッドハット、富士通など多くの大企業がPostgreSQLを使用して製品を構築しています。

[PostgreSQL 用 Azure データベース](https://azure.microsoft.com/services/postgresql/)は、オープン ソースの Postgres データベース エンジンに基づく、完全に管理されたリレーショナル データベース サービスです。 このサービスは、C++、Java、Python、ノード、C、PHP\#など、多くの開発プラットフォームをサポートしています。 [コマンド ライン インターフェイス](https://datamigration.microsoft.com/scenario/postgresql-to-azurepostgresql?step=1)ツールまたは Azure データ移行サービスを使用して PostgreSQL データベースを移行できます。

ポストグレSQL用の Azure データベースには、次の 2 つのデプロイ オプションがあります。

- [単一サーバー](https://docs.microsoft.com/azure/postgresql/concepts-servers)の展開オプションは、複数のデータベースを配置できる集中管理ポイントです。 価格は、コアとストレージに基づいてサーバーごとに構成されます。

- [ハイパースケール(Citus)オプション](https://azure.microsoft.com/blog/get-high-performance-scaling-for-your-azure-database-workloads-with-hyperscale/)は、Citusデータ技術によって駆動されます。 1 つのデータベースを数百のノード*に水平方向にスケーリング*し、高速なパフォーマンスとスケールを実現することで、高いパフォーマンスを実現します。 このオプションを使用すると、エンジンはメモリに多くのデータを取り込み、数百のノードに対するクエリを並列化し、データのインデックスをより速く作成できます。

## <a name="nosql-data-in-azure"></a>Azure の NoSQL データ

Cosmos DB は、Azure クラウドで完全に管理されたグローバルに分散された NoSQL データベース サービスです。 コカ・コーラ、スカイプ、エクソンモービル、リバティ・ミューチュアルなど、世界中の多くの大企業に採用されています。

サービスが世界中のどこからでも高速な応答、高可用性、または柔軟なスケーラビリティを必要とする場合、Cosmos DB は優れた選択肢です。 図5-12は、Cosmos DBを示す。

![コスモスDBの概要](./media/cosmos-db-overview.png)

**図 5-12**: コスモス DB の概要

上の図は、Cosmos DB で利用できる組み込みのクラウドネイティブ機能の多くを示しています。 このセクションでは、それらを詳しく見ていきます。

### <a name="global-support"></a>グローバル サポート

クラウドネイティブアプリケーションは、多くの場合、グローバルなユーザーを持ち、グローバル規模を必要とします。

Cosmos データベースを地域間または世界中に分散して、ユーザーの近くにデータを配置し、応答時間を短縮し、待ち時間を短縮できます。 サービスを一時停止または再デプロイしなくても、リージョンにデータベースを追加したり、リージョンからデータベースを削除したりできます。 バックグラウンドで、Cosmos DB は、構成された各リージョンにデータを透過的に複製します。

Cosmos DB はグローバル レベルで[アクティブ/アクティブ](https://kemptechnologies.com/white-papers/unfog-confusion-active-passive-activeactive-load-balancing/)クラスタリングをサポートし、*書き込みと読み取りの両方*をサポートするようにデータベース領域を設定できるようにします。

[マルチマスター](https://docs.microsoft.com/azure/cosmos-db/multi-master-benefits)プロトコルは、次の機能を有効にする Cosmos DB の重要な機能です。

- 無制限でエラスティックな書き込みと読み取りのスケーラビリティ。

- 全世界での 99.999% の読み取りおよび書き込みの可用性。

- 99 パーセンタイルで 10 ミリ秒未満の処理性能が保証された読み取りと書き込み。

Cosmos DB[マルチホーミング API を](https://docs.microsoft.com/azure/cosmos-db/distribute-data-globally)使用すると、マイクロサービスは最も近い Azure リージョンを自動的に認識し、要求を送信します。 最も近いリージョンは、設定を変更せずに Cosmos DB によって識別されます。 リージョンが使用できなくなった場合、マルチホーミング機能は、次に近い利用可能なリージョンにリクエストを自動的にルーティングします。

### <a name="multi-model-support"></a>マルチモデルサポート

モノリシック アプリケーションをクラウドネイティブ アーキテクチャに再プラットフォーム化する場合、開発チームは、オープンソースの NoSQL データ ストアを移行する必要がある場合があります。 Cosmos DB は、*マルチモデル*データ プラットフォームを使用して、これらの NoSQL データストアへの投資を維持するのに役立ちます。 図 5-13 は、サポートされている NoSQL[互換性 API を示しています](https://www.wikiwand.com/en/Cosmos_DB)。

![コスモス DB プロバイダー](./media/cosmos-db-providers.png)

**図 5-13**: Cosmos DB プロバイダ

開発チームは、既存の Mongo、Gremlin、または Cassandra データベースを、データやコードに対する最小限の変更で Cosmos DB に移行できます。 新しいアプリの場合、開発チームは、オープン ソース オプションまたは組み込みの SQL API モデルから選択できます。

> 内部的には、Cosmos はプリミティブデータ型で構成された単純な構造体形式でデータを格納します。 各要求に対して、データベース エンジンはプリミティブ データを選択したモデル表現に変換します。

前の図の 5-13 では、[テーブル API](https://docs.microsoft.com/azure/cosmos-db/table-introduction)オプションに注意してください。 この API は、Azure テーブル ストレージの進化です。 どちらも同じ基になるテーブル モデルを共有しますが、Cosmos DB テーブル API は Azure ストレージ API では利用できないプレミアム機能強化を追加します。 これらの機能は、図 5-4 で対照的です。

![Azure Table API](media/azure-table-api.png)

**図 5-14**: Azure テーブル API プロバイダー

Azure テーブル ストレージを使用するマイクロサービスは、簡単に Cosmos DB テーブル API に移行できます。 コードに変更を加える必要はありません。

### <a name="tunable-consistency"></a>チューニング可能な一貫性

前の「*リレーショナルと NoSQL」* のセクションで、*データの整合性*の主題について説明しました。 データの整合性とは、データの*整合性*を指します。 分散データを持つクラウドネイティブサービスはレプリケーションに依存しており、読み取り一貫性、可用性、待機時間の間の基本的なトレードオフを行う必要があります。

ほとんどの分散データベースでは、開発者は、強力な一貫性と最終的な一貫性という 2 つの一貫性モデルから選択できます。 *強力な一貫性*は、データプログラミングのゴールドスタンダードです。 更新がすべてのデータベース コピーにレプリケートされるのを待つ待機時間がシステムで発生する必要がある場合でも、クエリが常に最新のデータを返すことを保証します。 *最終的な整合性*を保つデータベースは、データが最新のコピーでない場合でも、データをすぐに返します。 後者のオプションを使用すると、可用性の向上、拡張性の向上、パフォーマンスの向上が可能になります。

Azure Cosmos DB には、図 5-15 に示す 5 つの明確に定義された[一貫性モデル](https://docs.microsoft.com/azure/cosmos-db/consistency-levels)が用意されています。

![コスモスDB整合性グラフ](./media/cosmos-consistency-level-graph.png)

**図 5-15**: コスモス DB の整合性レベル

 これらのオプションを使用すると、データの一貫性、可用性、パフォーマンスを得るために、正確な選択と細かいトレードオフを行うことができます。 図 5-16 に各レベルを示します。

![コスモス DB の一貫性レベル](./media/cosmos-db-consistency-levels.png)

**図 5-16**: Cosmos DB 整合性レベルの説明

記事では[、9ボールの背後にある: Cosmos DB の一貫性レベルの説明](https://blog.jeremylikness.com/blog/2018-03-23_getting-behind-the-9ball-cosmosdb-consistency-levels/)、 Microsoft クラウド開発者の提唱ジェレミー類似性 5 つのモデルの優れた説明を提供します。

### <a name="partitioning"></a>[パーティション分割]

Azure Cosmos DB では、自動[パーティション分割](https://docs.microsoft.com/azure/cosmos-db/partitioning-overview)を採用して、クラウド ネイティブ サービスのパフォーマンス ニーズに合わせてデータベースを拡張します。

データベース、コンテナー、およびアイテムを作成して、Cosmos DB データのデータを管理します。

コンテナーは Cosmos DB データベースに存在し、スキーマに依存しないアイテムのグループを表します。 項目は、コンテナーに追加するデータです。 ドキュメント、行、ノード、またはエッジとして表されます。 コンテナーに追加されたすべての項目は自動的にインデックスが作成されます。

コンテナを分割するために、項目は論理区画と呼ばれる別個のサブセットに分割されます。 論理パーティションは、コンテナー内の各項目に関連付けられているパーティション キーの値に基づいて設定されます。 図 5-18 は、パーティションキー値に基づいて論理パーティションを持つ 2 つのコンテナーを示しています。

![コスモスDBパーティション力学](./media/cosmos-db-partitioning.png)

**図 5-18**: Cosmos DB パーティショニングメカニクス

前の図では、各項目に 「都市」 または 「空港」のいずれかのパーティション キーが含まれている方法に注意してください。 キーによって、項目の論理区画が決まります。 市町村コードが含まれるアイテムは、左側のコンテナに、空港コードが設定されたアイテムは右側のコンテナに割り当てられます。 パーティション キー値と ID 値を組み合わせると、項目のインデックスが作成され、アイテムが一意に識別されます。

内部的には、Cosmos DB は、コンテナのスケーラビリティとパフォーマンスのニーズを満たすために、物理パーティション上の[論理パーティション](https://docs.microsoft.com/azure/cosmos-db/partition-data)の配置を自動的に管理します。 アプリケーションのスループットとストレージ要件が増加すると、Azure Cosmos DB は、より多くのサーバーに論理パーティションを再配布します。 再配布操作は Cosmos DB によって管理され、中断やダウンタイムなしで呼び出されます。

## <a name="newsql-databases"></a>データベースの新規作成

*NewSQL* は、NoSQL の分散スケーラビリティとリレーショナル データベースの ACID 保証を組み合わせた新しいデータベース テクノロジです。 NewSQL データベースは、トランザクションの完全なサポートと ACID 準拠を使用して、分散環境全体で大量のデータを処理する必要があるビジネス システムにとって重要です。 NoSQL データベースは、大規模なスケーラビリティを提供できますが、データの一貫性は保証されません。 データの一貫性がなくなると、一貫性のない問題が発生すると、開発チームに負担が生じる可能性があります。 開発者は、マイクロサービス コードにセーフガードを組み込み、データの不整合によって発生する問題を管理する必要があります。

クラウド ネイティブ コンピューティング ファウンデーション (CNCF) には、いくつかの NewSQL データベース プロジェクトが用意されています。

| Project | 特性 |
| :-------- | :-------- |
| ゴキブリDB |グローバルに拡張する ACID 準拠のリレーショナル データベース。 新しいノードをクラスターに追加すると、ゴキブリ DB はインスタンスと地域間でデータのバランスを取ります。 信頼性を確保するためにレプリカを作成、管理、配布します。 それはオープンソースで、自由に利用できます。  |
| ティジド | ハイブリッド トランザクションおよび分析処理 (HTAP) ワークロードをサポートするオープン ソース データベース。 MySQL と互換性があり、水平スケーラビリティ、強力な一貫性、高可用性を備えています。  TiDB は、MySQL サーバーのように動作します。 既存の MySQL クライアントライブラリを引き続き使用できます。 |
| ユガバイトDB | オープンソースの高性能な分散型 SQL データベース。 低いクエリ待機時間、障害に対する復元性、およびグローバル データの分散をサポートします。 ユガバイト DB は PostgressSQL 互換であり、スケールアウト RDBMS およびインターネット規模の OLTP ワークロードを処理します。 この製品は NoSQL もサポートしており、Cassandra と互換性があります。 |
|ヴィテス | Vitessは、MySQLインスタンスの大規模なクラスターをデプロイ、スケーリング、管理するためのデータベースソリューションです。 パブリックまたはプライベートクラウドアーキテクチャで実行できます。 これは、多くの重要なMySQL機能と垂直および水平シャーディングサポートの両方を組み合わせた拡張します。 YouTube が発信した Vitess は、2011 年以降、すべての YouTube データベース トラフィックを提供しています。 |

上の図のオープンソースプロジェクトは、クラウドネイティブコンピューティング財団から入手できます。 3 つの製品は、.NET Core サポートを含む完全なデータベース製品です。 もう 1 つの Vitess は、MySQL インスタンスの大規模なクラスターを水平方向にスケーリングするデータベース・クラスタリング・システムです。

NewSQL データベースの設計目標の重要な目的は、Kubernetes でネイティブに動作し、プラットフォームの復元力とスケーラビリティを活用することです。

NewSQL データベースは、基盤となる仮想マシンをすぐに再起動または再スケジュールできる一時的なクラウド環境で繁栄するように設計されています。 データベースは、データの損失やダウンタイムを伴わずにノード障害を生き残るように設計されています。 例えば、ゴキブリDBは、クラスター内のノード全体でデータの3つの一貫したレプリカを維持することで、マシンの損失を生き残ることができます。

Kubernetes は*Services コンストラクト*を使用して、クライアントが同一の NewSQL データベースプロセスのグループに対して単一の DNS エントリからアドレスを指定できるようにします。 データベース インスタンスと関連付けられているサービスのアドレスを切り離すことで、既存のアプリケーション インスタンスを中断することなく拡張できます。 任意の時点で任意のサービスに要求を送信すると、常に同じ結果が得られます。

このシナリオでは、すべてのデータベース インスタンスが等しくなります。 プライマリまたはセカンダリの関係はありません。 ゴキブリDBで見つかった*コンセンサスレプリケーション*のような技術は、任意のデータベースノードが任意の要求を処理することを可能にします。 負荷分散要求を受信するノードに必要なデータがローカルに含まれている場合は、すぐに応答します。 正しくない場合、ノードはゲートウェイになり、正しい応答を得るために適切なノードに要求を転送します。 クライアントの観点から見ると、すべてのデータベース ノードは同じで、1 台のマシン システムの一貫性が保証される単一の*論理*データベースとして表示されます。

NewSQL データベースの背後にある仕組みを詳しく見る方法については[、「DASH: Kubernetes ネイティブ データベースの 4 つのプロパティ」の記事を参照してください](https://thenewstack.io/dash-four-properties-of-kubernetes-native-databases/)。

## <a name="data-migration-to-the-cloud"></a>クラウドへのデータ移行

時間のかかるタスクの 1 つに、データ プラットフォーム間でのデータの移行があります。 [Azure データ移行サービス](https://azure.microsoft.com/services/database-migration/)は、このような作業を迅速化するのに役立ちます。 最小限のダウンタイムで、複数の外部データベース ソースから Azure Data プラットフォームにデータを移行できます。 ターゲット プラットフォームには、次のサービスが含まれます。

- Azure SQL データベース
- Azure Database for MySQL
- Azure Database for MariaDB
- Azure Database for PostgreSQL
- Cosmos DB
  
このサービスでは、小規模または大規模の両方で移行を実行するために必要な変更について説明する推奨事項を提供します。

>[!div class="step-by-step"]
>[前次](Database-per-microservice.md)
>[Next](azure-caching.md)
