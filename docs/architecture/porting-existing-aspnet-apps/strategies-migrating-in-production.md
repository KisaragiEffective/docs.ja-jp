---
title: 運用環境での実行中に移行するための戦略
description: 大規模なアプリをすべて一度に ASP.NET MVC から ASP.NET Core に移行することが不可能な場合もあるでしょう。 アプリを既存のユーザーのために運用環境で実行し続けながら ASP.NET Core に移行するためのいくつかの戦略について説明します。
author: ardalis
ms.date: 11/13/2020
ms.openlocfilehash: 4910984cb281139493aa5424809ba3eedab776e9
ms.sourcegitcommit: 42d436ebc2a7ee02fc1848c7742bc7d80e13fc2f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/04/2021
ms.locfileid: "102401347"
---
# <a name="strategies-for-migrating-while-running-in-production"></a>運用環境での実行中に移行するための戦略

多くのチームでは、.NET Core への移行を計画している .NET Framework アプリがありますが、アプリが非常に大規模なので移行を完了するまでにかなりの時間が必要になります。 一つ一つ移行を実行している間、元のアプリを機能させ続ける必要があります。 アプリの古いバージョンと新しいバージョンをサイドバイサイドで一緒に動作させるか、古いバージョンを何らかの方法で少なくとも中断させることなくインプレースで移行するための方法が必要になります。 チームは、これらの目標をサポートするためにさまざまな戦略を使用できます。

## <a name="refactor-the-net-framework-solution"></a>.NET Framework ソリューションをリファクターする

.NET Framework アプリを .NET Core に移植する予定の場合は、手始めに、アプリを .NET Core でより適切に動作するようにリファクターすることをお勧めします。 これは、個々のクラス ライブラリを .NET Standard をターゲットにするように更新し、ASP.NET MVC プロジェクトからできるだけ多くのロジックをそれらのクラス ライブラリ内に移動することを意味します。 .NET Standard ライブラリに含まれているコードは、.NET Framework から .NET Core に比較的簡単に移動できるはずです。

リファクタリングの際は、優れたリファクタリングの基本原則に従っていることを確認してください。 たとえば、リファクタリングを開始する前に、システムの動作を確認するテストを作成します。 完了したらこれらのテストを実行して、システムの動作を変更していないことを確認します。 信頼できる適切な一連の自動テストがまだない場合は、システムに特性テストを追加する必要があるかもしれません。

## <a name="extract-front-end-assets-to-a-cdn"></a>フロントエンド アセットを CDN に抽出する

.NET Framework アプリにスクリプト、CSS ファイル、画像などの静的アセットが数多く含まれている場合は、それらを別の CDN に移行することもできます。 その後、それらのアセットの CDN リンクを参照するように既存のアプリを更新します。 アプリを .NET Core に移植するときに、これらの静的ファイルは移行に含まれませんが、ASP.NET Core アプリ内でも引き続き CDN から参照できます。

## <a name="extract-and-migrate-individual-microservices"></a>個々のマイクロサービスを抽出して移行する

大規模な .NET Framework アプリは、個別に移行できる個別のフロントエンド システムで既に構成されている場合があります。 または、既存の ASP.NET MVC アプリの一部が新しい ASP.NET Core マイクロサービスの実装に取り込まれていて、マイクロサービス アーキテクチャへの移行に適している場合もあります。 マイクロサービスの詳細については、関連の電子ブック「[.NET マイクロサービス: コンテナー化された .NET アプリケーションのアーキテクチャ](https://aka.ms/microservicesebook)」を参照してください。

たとえば、既存のアプリに、ユーザーのサインインと登録に関連する一連の機能が含まれている場合があります。 これらを、ASP.NET Core を使用して構築および展開できる別のマイクロサービスに移行した後で、レガシ .NET Framework アプリに統合することができます。 次に、アプリに、個々のユーザーのショッピング カートを追跡する専用のページがいくつか含まれている場合があります。 これらのページも、独自の別のマイクロサービスに取り込んでから、既存のアプリに再度統合することができます。 この方法では、元の .NET Framework アプリが運用環境で引き続き実行されますが、その機能のより多くが最新の .NET Core マイクロサービスから提供されるようになります。

## <a name="deploy-multiple-versions-of-the-app-side-by-side-in-iis"></a>IIS 内でアプリの複数のバージョンをサイドバイサイドで展開する

ホスト ヘッダーとリダイレクトの組み合わせを使用して、既存の ASP.NET MVC アプリを同じ IIS サーバー上の ASP.NET Core アプリとサイドバイサイドで実行されるように構成できます。 機能の一部 (個別のコントローラーなど) が ASP.NET Core に移植されると、そのルートと URL が、ASP.NET Core Web サイトまたはサブアプリケーションをターゲットにするように IIS 内でマップされます (IIS 仮想ディレクトリは ASP.NET Core アプリではサポートされていません)。 ASP.NET Core アプリは IIS サブアプリケーション (サブアプリ) としてホスティングできます。 サブアプリのパスは、ルート アプリの URL の一部になります。

## <a name="apply-the-strangler-pattern"></a>ストラングラー パターンを適用する

大規模な ASP.NET MVC アプリを、機能の一部を段階的に移行することで、新しい ASP.NET Core アプリに段階的に置き換えることができます。 その方法の 1 つは、[ストラングラー パターン](/azure/architecture/patterns/strangler)と呼ばれます。これは、木々に絡み付いて最終的には枯らしてしまう絞め殺しの木にちなんで名づけられました。 このアプローチでは、まず、既存のソリューションの上にファサード レイヤーを実装します。 このファサードは、問題に対する新しいアプローチ、または API ゲートウェイなどの既製のソリューションを使用して構築する必要があります。

ファサードが設置されたら、その一部を新しい ASP.NET Core アプリにルーティングできます。 元の .NET Framework アプリのより多くの部分を .NET Core に移植するにつれて、ファサードの機能全体のより多くの部分を新しいシステムに送信し、ファサード レイヤーを更新していきます。 図 3-5 に、時間の経過に伴うストラングラー パターンの進行を示します。

## <a name="multi-targeting-approaches"></a>マルチ ターゲットによるアプローチ

マルチターゲットとフレームワークごとの個別のコード パスを使用することで、.NET Framework をターゲットとする大規模なアプリを時間をかけて ASP.NET Core に移行することができます。 たとえば、両方の環境で実行される必要があるコードを、.NET Framework での実行時と .NET Core での実行時とで異なる機能を実装したり異なる依存関係を使用したりするように、[プリプロセッサ ディレクティブ `#if`](../../csharp/language-reference/preprocessor-directives/preprocessor-if.md) を使用して変更できます。 別の方法として、ターゲットとなっているフレームワークに基づいて異なるファイル セットを含むようにプロジェクト ファイルを変更することもできます。 プロジェクト ファイルはさまざまな glob パターン (`*.core.cs` など) を使用して、ターゲットとなっているフレームワークに応じて異なるソース ファイルのセットを含むことができます。

これらの手法により、新しい機能が追加されてアプリ (の一部) が.NET Core を使用するように移植されるときに、1 つの共通のコードベースを保守するだけで済みます。

![図 3-5](media/Figure3-5.png)

**図 3-5** 時間の経過に伴うストラングラー パターン。

最終的には、ファサード レイヤー全体が新しいモダンな実装に対応します。 この時点で、レガシ システムとファサード レイヤーの両方を廃止できます。

## <a name="summary"></a>まとめ

多くの場合、大規模な ASP.NET MVC および Web API アプリはすべて一度に ASP.NET Core に移植されるのではなく、時間をかけて段階的に移行されます。 このセクションでは、この段階的な移行を実行するためのいくつかの戦略について説明しました。 ご自分の組織とアプリに最適なものを選択してください。

## <a name="references"></a>リファレンス

- [.NET マイクロサービス: コンテナー化された .NET アプリケーションのアーキテクチャ](https://aka.ms/microservicesebook)
- [eShopOnContainers 参照マイクロサービス アプリケーション](https://github.com/dotnet-architecture/eShopOnContainers)
- [IIS を使用した Windows での ASP.NET Core のホスト](/aspnet/core/host-and-deploy/iis/)
- [ストラングラー パターン](/azure/architecture/patterns/strangler)

>[!div class="step-by-step"]
>[前へ](understand-update-dependencies.md)
>[次へ](example-migration-eshop.md)
